name: Preview PHP Site via Cloudflare Tunnel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      # 1. Pull down your code (index.html, fV9o.php, etc.)
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Install PHP + extensions & enable allow_url_fopen, disable JIT
      - name: Setup PHP 8.1
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring,intl,openssl,curl
          ini-values: |
            allow_url_fopen=1
            jit=0

      # 3. Clean and recreate your coinimp-cache directory
      - name: Clean CoinImp cache directory
        run: |
          rm -rf coinimp-cache
          mkdir -p coinimp-cache
          chmod 777 coinimp-cache

      # 4. Install the cloudflared binary
      - name: Setup cloudflared
        uses: AnimMouse/setup-cloudflared@v2

      # 5. Fire up PHP’s built-in server, then open a free Cloudflare Tunnel
      - name: Serve & Tunnel
        run: |
          # serve your repo root (index.html + fV9o.php) on port 8080
          php -S 0.0.0.0:8080 -t . &
          # quick TryCloudflare tunnel—logs a *.trycloudflare.com URL
          cloudflared tunnel --url http://localhost:8080
